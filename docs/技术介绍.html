<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>项目技术介绍</title>
<style>
body{margin:24px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;line-height:1.8;color:#111827;background:#ffffff}
.container{max-width:960px;margin:0 auto}
.title{font-size:28px;font-weight:700;margin-bottom:12px}
.subtitle{font-size:14px;color:#6b7280;margin-bottom:24px}
.content h1,.content h2,.content h3{color:#0f172a}
.content h1{font-size:28px}
.content h2{font-size:22px;margin-top:18px}
.content h3{font-size:18px;margin-top:16px}
.content code{background:#f3f4f6;color:#111827;padding:2px 6px;border-radius:4px}
.content pre{background:#f8fafc;color:#111827;border:1px solid #e5e7eb;border-radius:8px;padding:16px;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:15px;line-height:1.8}
.content a{color:#2563eb;text-decoration:none}
.content a:hover{text-decoration:underline}
</style>
</head>
<body>
<div class="container">
<div class="title">项目技术介绍</div>
<div class="subtitle">架构、亮点与实现细节</div>
<div id="app" class="content"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script type="text/markdown" id="md">
# 项目技术介绍

**架构总览**
- 后端框架：Flask（消息接入、仪表盘与管理接口）
- 智能体与解析：LangGraphAgent（业务/查询/帮助路由）、MessageTemplateParser（模板解析）
- 业务服务：BusinessService（状态机、权限校验、日志与实体更新）
- 数据访问：SQLAlchemy 模型与会话
- 前端与可视化：单页`Optimize Page Content/src/index.html`，通过`/dashboard`直接发送

**Text-to-SQL 准确率提升**
- 模式选择：三种工作模式（LangChain、OpenAI直连、规则化回退），在无密钥或依赖失败时自动回退，保证稳定可用
- 结构约束：在提示中注入数据库结构描述（M-Schema 与简化结构），促使模型使用真实字段与表，降低臆造字段风险
- 枚举引导：枚举值（平台、业务类型、团队、阶段等）作为语义锚点，帮助模型生成更符合业务语义的过滤条件
- 会话上下文：在提示中加入近期问答摘要，维持用户语境与筛选条件的一致性
- 仅输出SQL：提示明确要求只产出SQL文本，减少解释性冗余与格式偏差，提高可执行性
- 回退规则：当LLM不可用时使用规则化模板生成查询，牺牲表达性但确保正确性与可控性
- 静态自检：对生成的SQL做规则化体检（SELECT 限制、GROUP BY 完备性、JOIN 正确性、IN+LIMIT 兼容、DISTINCT+ORDER BY 修复、移除不必要的 is_verified 过滤），降低执行错误与数据偏差
- 错误驱动改写：根据数据库错误自动改写语句并重试（如 IN+LIMIT 改 JOIN 派生表、DISTINCT+ORDER BY 改分组派生表），提升鲁棒性

**LangGraph × Text-to-SQL 结合方式**
- 解析节点将消息分流为业务、查询或帮助三类
- 查询类消息进入 SQLAgent：根据模式选择初始化，使用结构化提示生成 SQL，再查询数据库并整理结果
- 生成节点统一组合业务与查询的响应文本，返回群内或管理端
- 这种“图路由 + 可插拔查询”的方式，确保业务路径清晰、查询能力弹性可控

**LangGraph 设计**
- 节点：`parse_message`、`handle_business_message`、`handle_query_message`、`handle_help_message`、`generate_response`
- 入口：`parse_message`为单一入口，按条件边分流到三类处理节点
- 终止：`generate_response`汇总输出后终止
- 优点：显式的节点边界与条件路由，便于扩展（新增节点/策略）、易于观测与调试

**ReAct Agent 设计与落地**
- 概念：Reason + Act 循环，先思考再调用工具，形成可观测步骤链路
- 图路由：查询类消息进入 `handle_query_message`，其内部串联工具步骤并输出总结
- 步骤映射（查询类）：
  1) 获取 M-Schema
  2) 生成 SQL（支持会话记忆）
  3) 评估与修复 SQL（静态自检、规则改写、LLM 复审）
  4) 执行 SQL（只允许 SELECT，危险词过滤，错误驱动改写）
  5) 总结结果为群聊文本，并记录 ReAct 步骤日志
- 工具封装：通过 `tools/sql_tools.py` 暴露统一接口（`get_mschema/generate_sql/evaluate_sql/execute_sql/summarize_result`），由单例 `SQLAgent` 承载能力
- 记忆与上下文：按发送者维护最近 N 轮问答，生成与总结时注入简化上下文
- 安全与鲁棒性：包含 SELECT 严格限制、危险关键词拦截、IN+LIMIT 与 DISTINCT+ORDER BY 改写重试
- 自检与修复细则：聚合与 GROUP BY 完备性、联系方式 JOIN 字段校验、未请求验证却过滤 `is_verified=1`、顶层 `ORDER BY/LIMIT` 顺序、DISTINCT 排序列不在选择等

**数据模型简述**
- `StaffMapping`：人员映射（群昵称ID、角色、团队）
- `Parents`：家长主记录（编号、渠道、阶段、归属、金额等）
- `ParentContacts`：联系方式（类型、值、主标记）
- `ProcessLogs`：流程操作日志（含分配快照）
- `FollowupFeedback`：销售反馈
- `RawMessages`：原始群消息入库

**端到端流程**
- 社媒按模板录入并分配，家长进入`待接手`
- 合伙人接手或补全微信号，进入`合伙人跟进中`
- 合伙人“转销售”，进入`销售跟进中`
- 销售反馈、成交或流失，更新状态与日志

**安全与合规**
- 不在代码中记录密钥；ORM 层隔离 SQL 注入风险
- 角色与团队变更保留快照到日志，并按需更新家长快照

**运维与部署**
- 启动：`python run.py`
- 健康检查：`GET /health`
- 仪表盘：`GET /dashboard`
- 上线建议使用 WSGI（如 gunicorn+gevent），并配置环境变量与数据库访问权限
</script>
<script>
var md=document.getElementById('md').textContent;document.getElementById('app').innerHTML=marked.parse(md);
</script>
</body>
</html>